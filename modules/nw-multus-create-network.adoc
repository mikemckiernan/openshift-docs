// Module included in the following assemblies:
//
// * networking/multiple_networks/configuring-macvlan.adoc
// * networking/multiple_networks/configuring-ipvlan.adoc
// * networking/multiple_networks/configuring-bridge.adoc
// * networking/multiple_networks/configuring-host-device.adoc

// Configuring Multus plug-ins using the Cluster Network Operator
// is nearly identical in each case.

// macvlan-basic is all YAML with `simpleMacvlanConfig`.
ifeval::["{context}" == "configuring-macvlan-basic"]
:plugin: macvlan
:net-def-name: network-macvlan-static
:macvlan:
:yaml:
endif::[]
// This is necessary for Whereabouts CNI which is JSON-only
ifeval::["{context}" == "configuring-macvlan"]
:plugin: macvlan
:net-def-name: network-macvlan-static
:macvlan:
:json:
endif::[]
ifeval::["{context}" == "configuring-ipvlan"]
:plugin: ipvlan
:net-def-name: network-ipvlan-static
:json:
endif::[]
ifeval::["{context}" == "configuring-bridge"]
:plugin: bridge
:net-def-name: network-bridge-static
:json:
endif::[]
ifeval::["{context}" == "configuring-host-device"]
:plugin: host-device
:net-def-name: network-host-device-static
:json:
endif::[]

[id="nw-multus-create-network_{context}"]
= Creating a network attachment definition for the {plugin} CNI plug-in

Perform the following steps to add a network attachment definition.
After you complete the steps, the additional network is defined and Multus can add an interface and attach a pod to the network when a pod specification references the network attachment definition name.

.Prerequisites

* Install the OpenShift CLI (`oc`).
* Log in as a user with `cluster-admin` privileges.

.Procedure

To create an additional network for your cluster, complete the following steps:

. Create a file, such as `{net-def-name}.yaml`, with contents that are similar to the following example:
+
ifeval::["{plugin}" == "bridge"]
[source,yaml,subs="attributes+"]
----
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: {net-def-name}
spec:
  config: '{
    "cniVersion": "0.4.0",
    "name": "{net-def-name}",
    "type": "bridge",
    "bridge": "mynet0",
    "ipam": {
      "type": "static",
      "addresses":[
        {
          "address": "192.168.12.99/24",
          "gateway": "192.168.12.1"
        },
        {
          "address": "3ffe:ffff:0:01ff::1/64",
          "gateway": "3ffe:ffff:0::1"
        }
      ],
      "routes": [
        { "dst": "0.0.0.0/0" },
        { "dst": "192.168.0.0/16", "gw": "192.168.12.1" }
      ]
    }
  }'
----
endif::[]
ifeval::["{plugin}" == "host-device"]
[source,yaml,subs="attributes+"]
----
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: {net-def-name}
spec:
  config: '{
    "cniVersion": "0.4.0",
    "name": "{net-def-name}",
    "type": "host-device",
    "device": "ens3",
    "ipam": {
      "type": "static",
      "addresses":[
        {
          "address": "192.168.12.99/24",
          "gateway": "192.168.12.1"
        },
        {
          "address": "3ffe:ffff:0:01ff::1/64",
          "gateway": "3ffe:ffff:0::1"
        }
      ],
      "routes": [
        { "dst": "0.0.0.0/0" },
        { "dst": "192.168.0.0/16", "gw": "192.168.12.1" }
      ]
    }
  }'
----
endif::[]
ifeval::["{plugin}" == "ipvlan"]
[source,yaml,subs="attributes+"]
----
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: {net-def-name}
spec:
  config: '{
    "cniVersion": "0.4.0",
    "name": "{net-def-name}",
    "type": "macvlan",
    "master": "ens3",
    "mode": "l2",
    "ipam": {
      "type": "static",
      "addresses":[
        {
          "address": "192.168.12.99/24",
          "gateway": "192.168.12.1"
        }
      ]
    }
  }'
----
endif::[]
ifdef::macvlan+json[]
[source,yaml,subs="attributes+"]
----
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: {net-def-name}
spec:
  config: '{
    "cniVersion": "0.4.0",
    "name": "{net-def-name}",
    "type": "ipvlan",
    "master": "ens3",
    "ipam": {
      "type": "static",
      "addresses":[
        {
          "address": "192.168.12.99/24",
          "gateway": "192.168.12.1"
        }
      ]
    }
  }'
----
endif::[]
ifdef::macvlan+yaml[]
[source,yaml,subs="attributes+"]
----
FIXME: Maybe let's move the simpleMacvlan example
       into someplace less conspicuous.
----
endif::[]

. Apply the manifest:
+
[source,terminal,subs="attributes+"]
----
$ oc apply -n <namespace> -f <{net-def-name}.yaml>
----
+
.Example output
[source,terminal,subs="attributes+"]
----
networkattachmentdefinition.k8s.cni.cncf.io/{net-def-name} created
----

.Verification steps

* Confirm that the network attachment definition exists by running the following command. Replace `<namespace>` with the namespace that you specified when you applied the manifest.
+
[source,terminal]
----
$ oc get network-attachment-definitions -n <namespace>
----
+
.Example output
[source,terminal,subs="attributes+"]
ifeval::["{plugin}" == "bridge"]
----
NAME                   AGE
{net-def-name}  14m
----
endif::[]
ifeval::["{plugin}" == "macvlan"]
----
NAME                    AGE
{net-def-name}  14m
----
endif::[]
ifeval::["{plugin}" == "ipvlan"]
----
NAME                   AGE
{net-def-name}  14m
----
endif::[]
ifeval::["{plugin}" == "host-device"]
----
NAME                        AGE
{net-def-name}  14m
----
endif::[]

ifeval::["{context}" == "configuring-macvlan-basic"]
:!macvlan:
:!net-def-name:
:!plugin:
:!yaml:
endif::[]
ifeval::["{context}" == "configuring-macvlan"]
:!json:
:!macvlan:
:!net-def-name:
:!plugin:
endif::[]
ifeval::["{context}" == "configuring-ipvlan"]
:!json:
:!net-def-name:
:!plugin:
endif::[]
ifeval::["{context}" == "configuring-bridge"]
:!json:
:!net-def-name:
:!plugin:
endif::[]
ifeval::["{context}" == "configuring-host-device"]
:!json:
:!net-def-name:
:!plugin:
endif::[]
